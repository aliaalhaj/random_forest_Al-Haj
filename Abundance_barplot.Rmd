---
title: "Abundance_BarPlot"
author: "Alia Al-Haj"
date: "October 25, 2019"
output: html_document
---

#Barplots of differences across factors for top 10 taxa

```{r top 10, include = TRUE, results = "hide"}
require(ggplot2)
require(extrafont)
require(tidyverse)
require(dplyr)
require(plyr)
top20 <- names(sort(taxa_sums(ps), decreasing=TRUE))[1:20] #sort phyloseq object by top 10 abundance taxa
ps.top20 <- transform_sample_counts(ps, function(OTU) OTU/sum(OTU)) #transform the sample counts to normalize across OTUs
ps.top20 <- prune_taxa(top20, ps) #trim the dataset for top 10 taxa only
taxa_sums(ps.top20)


#For error bars
# convert your processed phyloseq object into a dataframe
df <- psmelt(ps.top20)

# group by Treatment and Family, calculate mean abundance and standard error
avgs <- ddply(df, ~ Depth + Class, function(x) {
  mean <- mean(x$Abundance)
})

se <- ddply(df, ~ Depth + Class, function(x) {
  se <- sd(x$Abundance)/sqrt(mean(x$Abundance))
})

#Change column names and combine dataframes into one
colnames(avgs)[colnames(avgs)=="V1"] <- "mean"
colnames(se)[colnames(se)=="V1"] <- "se"
avgs$se <- se$se

#Log transform mean and se columns
avgs$log_mean <- log10(avgs$mean)
avgs$log_se <- log10(avgs$se)

# plot bar graph with standard deviation as error bars
p<-ggplot(data=avgs, aes(fill = Depth, x=Depth, y=log_mean)) +
  geom_bar( stat="identity", position="stack", color = "black") + #Makes it into a barplot
   ylab("Log Abundance") + #y-axis label
  facet_wrap(~Class, ncol = 4) + #This will make a graph for each class in our dataframe
  geom_errorbar(aes(ymin=log_mean-log_se, ymax=log_mean+log_se), width=.2, position=position_dodge(.9)) + # add error bars
  theme_bw() + theme(panel.grid.major = element_blank(), #get rid of all of the unnecessary color, grid lines, etc.
          panel.grid.minor = element_blank()) + scale_fill_manual(guide = "legend", name = "", labels = c("DCM", "MES", "MIX", "SURF"), 
                    values=c("midnightblue", "seagreen", "mediumorchid4", "darkgoldenrod4")) + #choose fill colors
  theme(legend.position = "none", panel.border = element_rect(colour = "black", fill=NA, size=1), aspect.ratio=1) + #remove legend
  theme(text=element_text(family="Times New Roman", size=14)) #Set font type and size. You will need to import font types to use common fonts.
p
```

Are any of these statistically different? We'll use an ANOVA to compare
```{r}
model = lm(Abundance ~ Class + Depth + Class:Depth,
           data = df)

library(car)

Anova(model,
      type = "II")

#Post-hoc test
library(lsmeans)

ph <- lsmeans(model,
        pairwise ~ Class + Depth,
        adjust="tukey")       ### Tukey-adjusted comparisons

ph
```
